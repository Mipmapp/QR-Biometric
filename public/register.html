<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Registration</title>
    <link rel="stylesheet" href="register.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
</head>

<body>
    <!-- Floating Menu Button -->
    <div class="floating-menu">
        <button id="menu-btn" class="menu-btn">☰</button>
        <div class="menu-options" id="menu-options">
            <button onclick="navigateTo('register')">Register</button>
            <button onclick="navigateTo('documents')">Files</button>
            <button onclick="navigateTo('scan')">Scan</button>
        </div>
    </div>

    <div id="qr-reader">
        <h2>Scan QR Code</h2>
        <div id="qr-box"></div>
        <p id="scan-result"></p>
    </div>

    <div id="register-form" style="display: none;">
        <h2>Register User</h2>
        <form id="user-form">
            <input type="hidden" id="edit-mode" value="false">
            <div class="qr-id-container">
                <input type="text" id="user-id" name="id" readonly>
                <button type="button" onclick="copyQRID()" class="copy-btn">ID</button>
            </div>

            <div class="user-type-selection">
                <button type="button" id="student-btn" class="user-type-btn active" data-type="student">Student</button>
                <button type="button" id="faculty-btn" class="user-type-btn" data-type="faculty">Faculty</button>
                <input type="hidden" id="userType" name="userType" value="student">
            </div>

            <div class="form-group">
                <label for="name">Full Name</label>
                <input type="text" id="name" name="name" required>
            </div>

            <div id="student-fields">
                <div class="form-group">
                    <label for="grade">Grade</label>
                    <select id="grade" name="grade">
                        <option value="">Select Grade</option>
                        <option value="7">Grade 7</option>
                        <option value="8">Grade 8</option>
                        <option value="9">Grade 9</option>
                        <option value="10">Grade 10</option>
                        <option value="11">Grade 11</option>
                        <option value="12">Grade 12</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="section">Section</label>
                    <input type="text" id="section" name="section">
                </div>
            </div>

            <div class="form-group">
                <label for="mobile_num">Mobile Number</label>
                <input type="text" id="mobile_num" name="mobile_num" required>
            </div>

            <div class="form-group">
                <label for="image">Upload Image</label>
                <input type="file" id="image" name="image" accept="image/*" onchange="previewImage()">
                <div id="image-preview">
                    <img id="preview-img" src="" alt="Image Preview"
                        style="max-width: 100%; height: auto; display: none;">
                </div>
            </div>

            <button type="submit" class="btn">Register</button>
        </form>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const studentBtn = document.getElementById("student-btn");
            const facultyBtn = document.getElementById("faculty-btn");
            const studentFields = document.getElementById("student-fields");
            const userTypeInput = document.getElementById("userType");
            const form = document.getElementById("user-form");
            let html5QrCode;

            function toggleFields(type) {
                studentFields.style.display = type === "student" ? "block" : "none";
                userTypeInput.value = type;
            }

            studentBtn.addEventListener("click", function () {
                studentBtn.classList.add("active");
                facultyBtn.classList.remove("active");
                toggleFields("student");
            });

            facultyBtn.addEventListener("click", function () {
                facultyBtn.classList.add("active");
                studentBtn.classList.remove("active");
                toggleFields("faculty");
            });

            form.addEventListener("submit", function (event) {
                event.preventDefault();
                const formData = new FormData(form);
                fetch("/register", {
                    method: "POST",
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            showNotification(data.message, "success");
                            form.reset();
                            document.getElementById("preview-img").style.display = "none";
                        }
                    })
                    .catch(() => {
                        showNotification("Registration failed!", "error");
                    });
            });

            function onScanSuccess(decodedText) {
                document.getElementById("user-id").value = decodedText;
                document.getElementById("register-form").style.display = "block";
                document.getElementById("qr-reader").style.display = "none";
                if (html5QrCode) html5QrCode.stop();
            }

            function initializeScanner() {
                html5QrCode = new Html5Qrcode("qr-box");
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);
            }
            initializeScanner();
        });

        function showNotification(message, type = "success") {
            const notification = document.createElement("div");
            notification.className = `notification ${type} show`;
            notification.innerHTML = `<span class="icon">${type === "success" ? "✅" : "❌"}</span> <span>${message}</span>`;

            document.getElementById("notification-container").appendChild(notification);

            setTimeout(() => {
                notification.classList.remove("show");
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        document.getElementById("menu-btn").addEventListener("click", function () {
            document.getElementById("menu-options").classList.toggle("show-menu");
        });

        function navigateTo(page) {
            if (page === 'register') {
                window.location.href = 'register.html';
            } else if (page === 'documents') {
                window.location.href = 'documents.html';
            } else if (page === 'scan') {
                window.location.href = '/';
            }
        }
    </script>
</body>

</html>