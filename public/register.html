<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration</title>
    <link rel="icon" type="image/png" href="assets/logo.png">
    <link rel="stylesheet" href="register.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
</head>

<body>
    <!-- Floating Menu Button -->
    <div class="floating-menu">
        <button id="menu-btn" class="menu-btn">â˜°</button>
        <div class="menu-options" id="menu-options">
            <button onclick="navigateTo('register')">Register</button>
            <button onclick="navigateTo('documents')">Files</button>
            <button onclick="navigateTo('scan')">Scan</button>
        </div>
    </div>

    <div class="qr-container">
        <div id="qr-text">
            <img src="assets/logo.png" alt="Logo" class="qr-logo">
            <p id="animated-text">Place your QR code inside the scanner to continue.</p>
        </div>

        <div id="qr-reader">
            <h2>Scan QR Code</h2>
            <div id="qr-box"></div>
            <p id="scan-result"></p><br>
        </div>
    </div>

    <div id="register-form" style="display: none;">
        <h2>Register User</h2>

        <form id="user-form" enctype="multipart/form-data">
            <input type="hidden" id="edit-mode" value="false">
            <div class="qr-id-container">
                <input type="text" id="user-id" name="id" readonly>
                <button type="button" onclick="copyQRID()" class="copy-btn">ID</button>
            </div>

            <div class="form-left">
                <div class="user-type-selection">
                    <button type="button" id="student-btn" class="user-type-btn active"
                        data-type="student">Student</button>
                    <button type="button" id="faculty-btn" class="user-type-btn" data-type="faculty">Faculty</button>
                    <input type="hidden" id="userType" name="userType" value="student">
                </div>

                <div class="form-group">
                    <label for="name">Full Name</label>
                    <input type="text" id="name" name="name" required>
                </div>

                <div id="student-fields">
                    <div class="form-group">
                        <label for="grade">Grade</label>
                        <select id="grade" name="grade">
                            <option value="">Select Grade</option>
                            <option value="7">Grade 7</option>
                            <option value="8">Grade 8</option>
                            <option value="9">Grade 9</option>
                            <option value="10">Grade 10</option>
                            <option value="11">Grade 11</option>
                            <option value="12">Grade 12</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-right">
                <div class="form-group">
                    <label for="section">Section</label>
                    <input type="text" id="section" name="section">
                </div>

                <div class="form-group">
                    <label for="mobile_num">Mobile Number</label>
                    <input type="tel" id="mobile_num" name="mobile_num" required pattern="\d{10,}"
                        placeholder="Enter a valid number">
                </div>

                <div class="form-group">
                    <label for="image">Upload Image</label>
                    <input type="file" id="image" name="image" accept="image/*" onchange="previewImage()">
                </div>
            </div>

            <button type="submit" class="btn">Register</button>
        </form>
    </div>

    <div id="image-preview-container">
        <button class="close-btn">
            <img src="assets/svg/close.svg" alt="Close">
        </button>
        <h3>Image Preview</h3>
        <div id="image-preview">
            <img id="preview-img">
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <script>
        function removeImage() {
            document.getElementById("preview-img").src = "";
            document.getElementById("preview-img").style.display = "none";
            document.getElementById("image-preview-container").style.display = "none";
            document.getElementById("image").value = ""; // Reset file input
        }

        function showNotification(message, type) {
            const container = document.getElementById("notification-container");
            if (!container) return;

            const notification = document.createElement("div");
            notification.classList.add("notification", type);
            notification.textContent = message;

            container.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function previewImage() {
            const fileInput = document.getElementById("image");
            const previewImg = document.getElementById("preview-img");
            const previewContainer = document.getElementById("image-preview-container");

            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();

                reader.onload = function (e) {
                    previewImg.src = e.target.result;
                    previewImg.style.display = "block";
                    previewContainer.style.display = "block";
                };

                console.log("File Selected:", fileInput.files[0]);
                reader.readAsDataURL(fileInput.files[0]);
            }
        }

        function toggleFields(type) {
            const gradeField = document.getElementById("student-fields");
            const sectionField = document.getElementById("section").parentNode; // Get section parent div

            if (type === "faculty") {
                gradeField.style.display = "none"; // Hide Grade for Faculty
                sectionField.style.display = "none";  // Hide Section for Faculty
            } else {
                gradeField.style.display = "block";
                sectionField.style.display = "block";
            }

            document.getElementById("userType").value = type; // Update hidden input value
        }

        document.addEventListener("DOMContentLoaded", function () {
            const studentBtn = document.getElementById("student-btn");
            const facultyBtn = document.getElementById("faculty-btn");
            const studentFields = document.getElementById("student-fields");
            const userTypeInput = document.getElementById("userType");
            const form = document.getElementById("user-form");
            let html5QrCode;

            studentBtn.addEventListener("click", function () {
                studentBtn.classList.add("active");
                facultyBtn.classList.remove("active");
                toggleFields("student");
            });

            facultyBtn.addEventListener("click", function () {
                facultyBtn.classList.add("active");
                studentBtn.classList.remove("active");
                toggleFields("faculty");
            });

            const closeButton = document.querySelector(".close-btn");

            if (closeButton) {
                closeButton.addEventListener("click", removeImage);
            }

            form.addEventListener("submit", function (event) {
                event.preventDefault();
                console.log("User Type Selected:", document.getElementById("userType").value); // Debugging
                const formData = new FormData(form);

                fetch("/register", {
                    method: "POST",
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            showNotification(data.message, "success");
                            form.reset();

                            // Return to QR Scanning after 2 seconds
                            setTimeout(() => {
                                document.getElementById("qr-reader").style.display = "block";
                                document.getElementById("qr-text").style.display = "block";
                                document.getElementById("register-form").style.display = "none";
                                removeImage();
                                initializeScanner();
                                form.reset();
                            }, 2000);
                        }
                    })
                    .catch(() => {
                        showNotification("Registration failed!", "error");

                        setTimeout(() => {
                            document.getElementById("qr-reader").style.display = "block";
                            document.getElementById("qr-text").style.display = "block";
                            document.getElementById("register-form").style.display = "none";
                            initializeScanner();
                            removeImage();
                        }, 2000);
                    });
            });

            function showRegisterForm() {
                const registerForm = document.getElementById("register-form");
                registerForm.style.display = "block";
                setTimeout(() => {
                    registerForm.classList.add("show");
                }, 10);
            }

            function showPopup(userData) {
                // Create the modal HTML
                const modalHTML = `
            <div id="custom-modal" class="modal-overlay">
                <div class="modal-content">
                    <h2>User Already Registered</h2>
                    <p>The ID is already in the system. Do you want to edit the existing record?</p>
                    <div class="modal-buttons">
                        <button id="edit-btn" class="modal-button edit">Edit</button>
                        <button id="try-again-btn" class="modal-button cancel">Try Again</button>
                    </div>
                </div>
            </div>
        `;

                // Append to body
                document.body.insertAdjacentHTML("beforeend", modalHTML);

                // Add animation
                setTimeout(() => {
                    document.getElementById("custom-modal").classList.add("show");
                }, 10);

                // Handle Edit button
                document.getElementById("edit-btn").addEventListener("click", function () {
                    document.getElementById("name").value = userData.name || "";
                    document.getElementById("section").value = userData.section || "";
                    document.getElementById("mobile_num").value = userData.mobile_num || "";

                    if (userData.userType === "faculty") {
                        document.getElementById("faculty-btn").click();
                        document.getElementById("userType").value = "faculty";
                    } else {
                        document.getElementById("student-btn").click();
                        document.getElementById("grade").value = userData.grade || "";
                    };

                    closePopup();
                });

                // Handle Try Again button
                document.getElementById("try-again-btn").addEventListener("click", function () {
                    document.getElementById("qr-reader").style.display = "block";
                    document.getElementById("qr-text").style.display = "block";
                    document.getElementById("register-form").style.display = "none";
                    initializeScanner();
                    closePopup();
                });
            }

            function closePopup() {
                const modal = document.getElementById("custom-modal");
                if (modal) {
                    modal.classList.remove("show");
                    setTimeout(() => modal.remove(), 300);
                }
            }

            function onScanSuccess(decodedText) {
                document.getElementById("user-id").value = decodedText;
                document.getElementById("qr-reader").style.display = "none";
                document.getElementById("qr-text").style.display = "none";

                fetch('registered.json')
                    .then(response => response.json())
                    .then(data => {
                        // Find the user in the array
                        const userData = data.find(user => user.id === decodedText);

                        if (userData) {
                            showPopup(userData);
                            // Prefill form with existing data
                            document.getElementById("name").value = userData.name || "";
                            document.getElementById("section").value = userData.section || "";
                            document.getElementById("mobile_num").value = userData.mobile_num || "";

                            if (userData.userType === "faculty") {
                                document.getElementById("faculty-btn").click();
                                document.getElementById("userType").value = "faculty";
                            } else {
                                document.getElementById("student-btn").click();
                                document.getElementById("grade").value = userData.grade || "";
                            }

                            if (userData.image) {
                                const previewImg = document.getElementById("preview-img");
                                previewImg.src = userData.image;
                                previewImg.style.display = "block";

                                const previewContainer = document.getElementById("image-preview-container");
                                previewContainer.style.display = "block";
                            }
                        } else {
                            showRegisterForm();
                        }
                        showRegisterForm();
                    })
                    .catch(() => {
                        showRegisterForm();
                    });

                if (html5QrCode) html5QrCode.stop();
            }

            function initializeScanner() {
                html5QrCode = new Html5Qrcode("qr-box");
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);
            }
            initializeScanner();
        });

        function navigateTo(page) {
            if (typeof html5QrCode !== "undefined" && html5QrCode !== null) {
                html5QrCode.stop().then(() => {
                    window.location.href = `/${page === "scan" ? "" : page}`;
                }).catch(() => {
                    window.location.href = `/${page}`;
                });
            } else {
                window.location.href = `/${page === "scan" ? "" : page}`;
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            const menuBtn = document.getElementById("menu-btn");
            const menuOptions = document.getElementById("menu-options");

            menuBtn.addEventListener("click", function () {
                menuOptions.classList.toggle("show-menu");
            });

            document.addEventListener("click", function (event) {
                if (!menuBtn.contains(event.target) && !menuOptions.contains(event.target)) {
                    menuOptions.classList.remove("show-menu");
                }
            });
        });
    </script>
</body>

</html>