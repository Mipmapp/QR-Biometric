<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Scan</title>
  <link rel="icon" type="image/png" href="assets/logo.png">
  <link rel="stylesheet" href="styles.css" />
  <script src="js/html5-qrcode.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" defer></script>
  <style>
    .loading-mark path {
      fill: white;
    }
  </style>
</head>

<body>
  <div class="bg">
    <ul class="glass">
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
    </ul>
  </div>

  <div id="loading-screen">
    <img src="assets/svg/mark.svg" alt="Loading Mark" class="loading-mark" />
  </div>

  <main style="display: none">
    <div id="scanner-container">
      <!-- Online/Offline Notification -->
      <div id="status-notification" class="status-notification">Online</div>

      <div id="reader"></div>
      <div id="result">
        <p id="default-result">Results will appear here.</p>
      </div>
    </div>
    <div id="fullscreen-buttons">
      <button class="fullscreen-button" id="maximize-button" style="display: flex">
        Maximize <img src="assets/svg/fullscreen-in.svg" alt="Maximize" />
      </button>
      <button class="fullscreen-button" id="minimize-button" style="display: none">
        Minimize <img src="assets/svg/fullscreen-out.svg" alt="Minimize" />
      </button>
    </div>
  </main>

  <!-- Audio files for match and error sounds -->
  <audio id="match-sound" src="assets/match.m4a" preload="auto"></audio>
  <audio id="error-sound" src="assets/error.mp3" preload="auto"></audio>

  <script>
    let scanner;

    // Check if online/offline and update the status notification
    window.addEventListener("online", () => {
      document.getElementById("status-notification").textContent = "Online";
      document.getElementById("status-notification").style.backgroundColor =
        "#28a745"; // Green for online
    });

    window.addEventListener("offline", () => {
      document.getElementById("status-notification").textContent = "Offline";
      document.getElementById("status-notification").style.backgroundColor =
        "#dc3545"; // Red for offline
    });

    // Show fullscreen buttons when status notification is clicked
    document
      .getElementById("status-notification")
      .addEventListener("click", () => {
        const buttonsContainer = document.getElementById("fullscreen-buttons");
        buttonsContainer.classList.toggle("show"); // Toggle the fullscreen buttons
      });

    function hideLoadingScreen() {
      const loadingScreen = document.getElementById("loading-screen");
      const main = document.querySelector("main");
      const scannerContainer = document.getElementById("scanner-container");
      scannerContainer.style.opacity = 1;
      scannerContainer.style.transform = "translateY(0)";
      main.style.display = "flex";

      setTimeout(() => {
        loadingScreen.style.opacity = "0";
        setTimeout(() => {
          loadingScreen.style.display = "none";
        }, 2000);
      }, 3000);
    }

    let cachedRegisteredUsers = null; // Store previously fetched data
    let scannedIds = {};

    async function fetchRegisteredUsers() {
      if (cachedRegisteredUsers) {
        return cachedRegisteredUsers;
      }

      try {
        const response = await fetch("registered.json");
        cachedRegisteredUsers = await response.json();
        return cachedRegisteredUsers;
      } catch (error) {
        console.error("Error loading registered users:", error);
        if (cachedRegisteredUsers) {
          return cachedRegisteredUsers;
        } else {
          return [];
        }
      }
    }

    function getDynamicQRBoxSize() {
      const minDimension = Math.min(window.innerWidth, window.innerHeight);
      return Math.floor(minDimension * 0.5); // 50% of the smallest dimension
    }

    function initializeScanner() {
      scanner = new Html5Qrcode("reader");
      scanner.start(
        { facingMode: "user" }, // Use the front camera
        { qrbox: getDynamicQRBoxSize(), fps: 20 },
        async (decodedText) => {
          const now = Date.now();

          // **Check if the same ID was scanned within the last 5 seconds**
          if (scannedIds[decodedText] && now - scannedIds[decodedText] < 5000) {
            console.log("Duplicate scan ignored:", decodedText);
            return;
          }

          // **Update scan timestamp**
          scannedIds[decodedText] = now;

          const registeredIds = await fetchRegisteredUsers();
          const user = registeredIds.find((user) => user.id === decodedText);
          const loginTime = new Date().toLocaleString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
          });

          if (user) {
            document.getElementById("result").innerHTML = ` 
            <div id="user-info">
              <img src="${user.image ? `${window.location.origin}${user.image}` : 'assets/svg/empty.jpg'}" 
         alt="${user.name}" class="user-image" />
              <h3 align="center" class="user-name">${user.name}</h3>
              <h4 class="user-grade-section">Grade ${user.grade} - ${user.section}</h4>
              <p class="login-time">Logged in Date & Time: ${loginTime}</p>
            </div>
          `;
            document.getElementById("match-sound").play();
            if (user.mobile_num) {
              sendMessage();
            };

            function sendMessage() {
              const message = `Dear Parent, 
              
${user.name} has arrived at school and entered the premises today, ${loginTime}. 
              
#SHCCI-HSD #ProjectNORMaL`;

              let number = user.mobile_num;
              // let number = "09510898845";

              function generateGUID(length) {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let result = '';
                for (let i = 0; i < length; i++) {
                  result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
              }

              if (number.startsWith("0")) {
                number = number.replace(/^0/, "+63");
              }

              const data = {
                data: {
                  target_device_iden: "ujCQgSifOuWsjzjBxOWGPY",
                  addresses: [number],
                  guid: generateGUID(15),
                  message,
                }
              };

              axios.post('https://api.pushbullet.com/v3/create-text', data, {
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Basic eXRLOEhVaEVlT0xVSTBZMmg5TmRvR1RPRXVXMlIxbTA6',
                  'Accept': '*/*',
                  'Cache-Control': 'no-cache',
                  'Pragma': 'no-cache',
                  'API-Version': '2014-05-07',
                  'Origin': 'https://www.pushbullet.com',
                  'Referer': 'https://www.pushbullet.com/',
                  'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Safari/537.36 Edg/133.0.0.0',
                }
              })
                .then(response => {
                  console.log('Response:', response.data);
                })
                .catch(error => {
                  console.error('Error:', error.response ? error.response.data : error.message);
                });
            }
          } else {
            document.getElementById("result").innerHTML = `
            <div id="user-not-found">
              <p class="id-not-found">No registered user found for this QR code: ${decodedText}</p>     
              <p class="login-time">Scan time: ${loginTime}</p>
            </div>`;
            document.getElementById("error-sound").play();
          }

          // **Reset result to "Results will appear here." after 5 seconds**
          setTimeout(() => {
            if (Date.now() - scannedIds[decodedText] >= 5000) {
              document.getElementById("result").innerHTML = `<p id="default-result">Results will appear here.</p>`;
            }
          }, 5000);
        },
        (error) => {
          console.error(error);
        }
      );
    }

    function adjustScannerContainer() {
      const scannerContainer = document.getElementById("scanner-container");
      const reader = document.getElementById("reader");
      const result = document.getElementById("result");

      if (window.innerWidth > window.innerHeight) {
        scannerContainer.style.flexDirection = "row";
        reader.style.width = "50%";
        result.style.width = "50%";
        scannerContainer.style.gap = "20px";
      } else {
        scannerContainer.style.flexDirection = "column";
        reader.style.width = "100%";
        result.style.width = "100%";
        scannerContainer.style.gap = "20px";
      }
    }

    let timeout;

    function hideFullscreenButtons() {
      const buttonsContainer = document.getElementById("fullscreen-buttons");
      buttonsContainer.classList.remove("show"); // Hide the buttons by removing the 'show' class
    }

    function resetButtonTimer() {
      clearTimeout(timeout); // Clear the previous timeout if any
      timeout = setTimeout(hideFullscreenButtons, 3000); // Set a new timeout to hide the buttons after 3 seconds
    }

    // Function to toggle fullscreen and show/hide buttons
    function toggleFullScreen() {
      const maximizeButton = document.getElementById("maximize-button");
      const minimizeButton = document.getElementById("minimize-button");

      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().then(() => {
          maximizeButton.style.display = "none";
          minimizeButton.style.display = "flex";
        });
      } else {
        document.exitFullscreen().then(() => {
          maximizeButton.style.display = "flex";
          minimizeButton.style.display = "none";
        });
      }

      resetButtonTimer(); // Reset the timer every time the buttons are clicked
    }

    function requestFullScreen() {
      const doc = document.documentElement;

      doc.requestFullscreen();
    }

    // Add event listeners for clicking maximize and minimize buttons
    document
      .getElementById("maximize-button")
      .addEventListener("click", () => {
        toggleFullScreen();
        resetButtonTimer(); // Reset the timer on maximize button click
      });
    document
      .getElementById("minimize-button")
      .addEventListener("click", () => {
        toggleFullScreen();
        resetButtonTimer(); // Reset the timer on minimize button click
      });

    window.addEventListener("resize", adjustScannerContainer);
    window.addEventListener("load", () => {
      requestFullScreen();
      hideLoadingScreen();
      adjustScannerContainer();
      initializeScanner(); // Automatically start scanner with the front camera
    });
  </script>
</body>

</html>